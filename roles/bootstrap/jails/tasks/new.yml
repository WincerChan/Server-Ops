- name: Check if jail is already created
  shell: "qjail list {{ jail_name }}"
  register: jail_check

- name:
  when: "'Error' in jail_check.stdout"
  block:
    - name: Create Qjail
      shell: qjail create -4 {{ jail_ip }} -n lo1 {{ jail_name }}

    - name: Enable Raw Socket Rustc Jail
      shell: "qjail config -k {{ jail_name }}"

    - name: Restart pf
      service:
        name: pf
        state: restarted

    - name: Start Jails
      shell: "qjail start {{ jail_name }}"

- include: mount.yml
  loop:
    - src: bin
      dest: /root/bin
    - src: lib
      dest: /usr/local/lib
  loop_control:
    loop_var: inside

- name: Disable Cron
  when: "'{{ jail_name }}' not in {{ needs_cron }}"
  community.general.sysrc:
    name: cron_enable
    value: "NO"
    jail: "{{ jail_name }}"
  delegate_to: "{{ jail_name }}"